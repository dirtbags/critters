<!DOCTYPE html>
<html>
    <head>
        <title>Critters</title>
        <style type="text/css">
body {
    background: black;
}
#p {
    width: 40em;
    height: 12em;
}
        </style>
        <script type="text/javascript">
TAU = Math.PI * 2;

loop_id = 0;

function start (p) {
    var canvas = document.getElementById("arena");
    var ctx = canvas.getContext("2d");
    var width = p[0];
    var colors = p[1];
    var moves = p[2];

    function critter(color, direction, x, y) {
        ctx.save();

        ctx.translate((x + .5) * 50, (width - (y + .5)) * 50);
        ctx.rotate(direction * TAU / 4);
        ctx.lineWidth = 2;
        ctx.strokeStyle = color;

        ctx.beginPath();
        ctx.moveTo(-3, 3);
        ctx.lineTo(-10, 10);
        ctx.lineTo(-10, 20);
        ctx.lineTo(0, 15);
        ctx.lineTo(10, 20);
        ctx.lineTo(10, 10);
        ctx.lineTo(3, 3);
        ctx.lineTo(3, -20);
        ctx.lineTo(0, -25);
        ctx.lineTo(-3, -20);
        ctx.closePath();
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(10, 10);
        ctx.lineTo(20, -5);
        ctx.lineTo(15, -20);
        ctx.moveTo(-10, 10);
        ctx.lineTo(-20, -5);
        ctx.lineTo(-15, -20);
        ctx.stroke();

        ctx.restore();
    }

    frameno = 0;
    function frame() {
        var desc = p[2][frameno];

        if (frameno >= moves.length) {
            if (frameno > moves.length + 5) {
                frameno = 0;
            }
        } else {
            canvas.width = canvas.width;

            for (var i in desc) {
                var c = desc[i];

                critter(colors[c[0]], c[1], c[2], c[3]);
            }
        }

        frameno = (frameno + 1);    
    }

    canvas.width = 50 * p[0];
    canvas.height = 50 * p[0];

    clearInterval(loop_id);
    loop_id = setInterval(frame, 265);
}

function submit() {
    var p = document.getElementById("p").value;
    var xhr = new XMLHttpRequest();

    function ready() {
        console.log(xhr);
        if (xhr.readyState == 4) {
            console.log(xhr.responseText);
            var frames = JSON.parse(xhr.responseText);

            start(frames);
        }
    }

    xhr.onreadystatechange = ready;
    xhr.open('POST', 'critters.cgi', true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send('p=' + escape(p));
}

        </script>
    </head>
    <body>
        <canvas id="arena"></canvas>
        <textarea id="p">right set-action!</textarea>
        <br>
        <button onclick="submit();">Submit</button>
    </body>
</html>
